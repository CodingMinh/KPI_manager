{% extends 'base.html' %}
{% block content %}
<h1>Welcome, {{ current_user.name }}!</h1>
<p>Use the navigation menu to manage departments, projects, and tasks.</p>
<p>Your top role level: {{ current_user.max_role_level }}</p>
<ul>
  {% set department_roles = {} %}
  {% for assignment in current_user.assignments %}
    {% set dept_id = assignment.department_id %}
    {% if dept_id not in department_roles or assignment.role.level > department_roles[dept_id].role.level %}
      {% set _ = department_roles.update({dept_id: assignment}) %}
    {% endif %}
  {% endfor %}

  {% for assignment in department_roles.values() %}
    <li>{{ assignment.role.name }} (Level {{ assignment.role.level }}) â€” {{ assignment.department.name }}</li>
  {% endfor %}

  {% set this_year = current_time.year %}
  {% set this_month = current_time.month %}
  <p>Your KPI for {{ this_month }}/{{ this_year }}:
    {% if current_user.get_kpi_for_month(this_year, this_month) %}
      {{ current_user.get_kpi_for_month(this_year, this_month) }}
      <a class="btn btn-sm btn-link"
        href="{{ url_for('user.user_kpi_detail', user_id=current_user.id, year=this_year, month=this_month) }}">
        view details
      </a>
    {% else %}
      No KPI yet
    {% endif %}
  </p>
</ul>
{% endblock %}